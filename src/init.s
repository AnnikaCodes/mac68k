# A very small bootloader in m68k Assembly to immediately invoke Rust code
# Largely based on https://github.com/jrsharp/HappyJon/blob/master/demo.s
.extern zig_entry

.include "include/macos.i"

# The ROM loads this many bytes from the start of the disk.
.equ stage1_size, 1024
.equ sector_size, 512
.equ first_level_size, sector_size * 2
.equ ScrnBase, 0x0824

begin:

ID:          .short  0x4C4B              /* boot blocks signature */
Entry:       bra     start          /* entry point to bootcode */
Version:     .short  0x4418              /* boot blocks version number */
PageFlags:   .short  0x00                /* used internally */
SysName:     pString "foo bar       "    /* System filename */
ShellName:   pString "foo bar       "    /* Finder filename */
Dbg1Name:    pString "foo bar       "    /* debugger filename */
Dbg2Name:    pString "foo bar       "    /* debugger filename */
ScreenName:  pString "foo bar       "    /* name of startup screen */
HelloName:   pString "foo bar       "    /* name of startup program */
ScrapName:   pString "foo bar       "    /* name of system scrap file */
CntFCBs:     .short  10                  /* number of FCBs to allocate */
CntEvts:     .short  20                  /* number of event queue elements */
Heap128K:    .long   0x00004300          /* system heap size on 128K Mac */
Heap256K:    .long   0x00008000          /* used internally */
SysHeapSize: .long   0x00020000          /* system heap size on all machines */
.include "include/floppy.i"

	/* Set up Heap: */
start:
	moveal SysZone,%a0
	addal %pc@(SysHeapSize),%a0
	SetApplBase
	movel SysZone,TheZone

	/* buffer size to store second stage booter */

	get_second_size %d0

	/* Allocate Memory for second stage loader */

	add.l	#4, %d0
	NewPtr
	move.l	%a0, %d0
	bne	malloc_ok
	move.l	#1, %d0
	SysError
malloc_ok:
	add.l	#3, %d0
	and.l	#0xFFFFFFFC.l, %d0

	/* load second stage */

	load_second

	/* call second stage bootloader */

/*
	move.l	#3, %d0
	SysError
	*/

	jmp	(%a0)
PRAM_buffer:
	.long	0
end:

.fill stage1_size - (end - begin), 1, 0xda

/* Start the framebuffer stuff: */
start_fb:
	/* movel	#0x3FA700, %a0 */ /* Start of framebuffer on 4MB Plus */
    bsr zig_entry
	movel	(ScrnBase), %a0

	/* clear screen */
	movel	#0x00000000, %d0
	movel	#5472, %d1
clear_loop:
	movel	%d0, (%a0)+
	subi	#1, %d1
	bne	clear_loop
.globl __asmSysError
__asmSysError:
    SysError
draw_string:

	lea	message(%pc), %a3
	movel	#24, %d1
	movel	#12, %d2
draw_str_loop:
	movew	(%a3)+, %d0
	movel	%d2, -(%sp)
	movel	%d1, -(%sp)
	movel	%d0, -(%sp)

	#jsr	draw_char
	movel	(%sp)+, %d0
	movel	(%sp)+, %d1
	movel	(%sp)+, %d2
	add.l	#1, %d1
	cmp	#0, %d0
	bne	draw_str_loop

	movel	#'a', %d0
	movel	#0, %d1
	movel	#0, %d2
	#jsr	draw_char

	movel	#'b', %d0
	movel	#0, %d1
	movel	#25, %d2
	#jsr	draw_char

	movel	#'c', %d0
	movel	#63, %d1
	movel	#0, %d2
	#jsr	draw_char

	movel	#'d', %d0
	movel	#63, %d1
	movel	#25, %d2
	#jsr	draw_char

end_loop:
	nop
	jmp	end_loop

fill_loop:

	movel	(%a1)+, %d0
	moveb	%d0, (%a0)+

	addal	#63, %a0	/* Move to next line */

check_dec:
	subi	#1, %d1
	bne	fill_loop

	movel	(%sp)+, %d1
	movel	(%sp)+, %d2

	rts

message:
	dc.w 0x48
	dc.w 0x65
	dc.w 0x6c
	dc.w 0x6c
	dc.w 0x6f
	dc.w 0x20
	dc.w 0x57
	dc.w 0x6f
	dc.w 0x72
	dc.w 0x6c
	dc.w 0x64
	dc.w 0x2e
	dc.w 0x00

message2:
	dc.w 48
	dc.w 49
	dc.w 50
	dc.w 51
	dc.w 52
	dc.w 53
	dc.w 54
	dc.w 0

buffer:
	dc.l 0b00000000000000000000000000100001
	dc.l 0b11111100000000000000000000000000
	dc.l 0b00000000000000000000000000000011
	dc.l 0b11111100000000000000000000000000
	dc.l 0b00000000000000000000000000111111
	dc.l 0b11111110000000000000000000000000
	dc.l 0b00000000000000000000000001110000
	dc.l 0b01111110000000000000000000000000
	dc.l 0b00000000000000000000000011110111
	dc.l 0b11111111111000000000000000000000
	dc.l 0b00000000000000000000000111010011
	dc.l 0b11111111111100000000000000000000
	dc.l 0b00000000000000000000001110000100
	dc.l 0b11111111111100000000000000000000
	dc.l 0b00000000000000000011111111111111
	dc.l 0b11111101111111100000000000000000
	dc.l 0b00000000000000000001111111111111
	dc.l 0b11111100001111110000000000000000
	dc.l 0b00000000000000000111111111111111
	dc.l 0b11111110000011100000000000000000
	dc.l 0b00000000000000001111111101111111
	dc.l 0b11111101001101111000000000000000
	dc.l 0b00000000000000001111111111111111
	dc.l 0b11111011010000011110000000000000
	dc.l 0b00000000000000001111111111111111
	dc.l 0b11111111111001011110000000000000
	dc.l 0b00000000000000011111111111111111
	dc.l 0b11111111110110011110000000000000
	dc.l 0b00000000000000011111011111111111
	dc.l 0b11111111111101100111000000000000
	dc.l 0b00000000000000011111111111111111
	dc.l 0b10111110111101110111000000000000
	dc.l 0b00000000000000111111011111110000
	dc.l 0b00000000001110111011000000000000
	dc.l 0b00000000000000111110111111000000
	dc.l 0b00000000000111110001000000000000
	dc.l 0b00000000000000100011111110000000
	dc.l 0b00000000000001111010000000000000
	dc.l 0b00000000000001101111111100000000
	dc.l 0b00000000000000111110000000000000
	dc.l 0b00000000000001100111110000000000
	dc.l 0b00000000000000111111000000000000
	dc.l 0b00000000000001011111000000000000
	dc.l 0b00000000000000011111000000000000
	dc.l 0b00000000000001011111000000000000
	dc.l 0b00000000000000011111100000000000
	dc.l 0b00000000000000101111000000000000
	dc.l 0b00000000000000011111000000000000
	dc.l 0b00000000000000111111100000000000
	dc.l 0b00000000000000011110100000000000
	dc.l 0b00000000000000110111100000000000
	dc.l 0b00000000000000011111100000000000
	dc.l 0b00000000000000110011100000000000
	dc.l 0b00000000000000001111100000000000
	dc.l 0b00000000000000111011100000000000
	dc.l 0b00000000000000011110000000000000
	dc.l 0b00000000000000111111100001000000
	dc.l 0b00000000000000011111000000000000
	dc.l 0b00000000000000111110011100101000
	dc.l 0b00000111000000110111000000000000
	dc.l 0b00000000000000111000110011111111
	dc.l 0b11100001000111111100000000000000
	dc.l 0b00000000000000111111011101101111
	dc.l 0b00100011110101101110000000000000
	dc.l 0b00000000000000111111000000000110
	dc.l 0b00110000000001001010000000000000
	dc.l 0b00000000000000010110100000000110
	dc.l 0b00000000000001001010000000000000
	dc.l 0b00000000000000010110110000000110
	dc.l 0b00010000000010001000000000000000
	dc.l 0b00000000000000000110000011110010
	dc.l 0b00001111111000010000000000000000
	dc.l 0b00000000000000001110000000000110
	dc.l 0b00000000000000010100000000000000
	dc.l 0b00000000000000010111000000001100
	dc.l 0b00000000000000010100000000000000
	dc.l 0b00000000000000010111000000001100
	dc.l 0b00000000000000010000000000000000
	dc.l 0b00000000000000010111000000001110
	dc.l 0b00000000000000010100000000000000
	dc.l 0b00000000000000001111000000000011
	dc.l 0b00000000000000010100000000000000
	dc.l 0b00000000000000000111000000000000
	dc.l 0b00000000000000010000000000000000
	dc.l 0b00000000000000000111000011000100
	dc.l 0b00000000000000010000000000000000
	dc.l 0b00000000000000000111000010111110
	dc.l 0b00000000000000110000000000000000
	dc.l 0b00000000000000000111000000110000
	dc.l 0b00000100000000110000000000000000
	dc.l 0b00000000000000000111000000001110
	dc.l 0b00001000000000110000000000000000
	dc.l 0b00000000000000000001100000000001
	dc.l 0b11100000000000100000000000000000
	dc.l 0b00000000000000000001100000000000
	dc.l 0b00000000000001100000000000000000
	dc.l 0b00000000000000000001110000000000
	dc.l 0b00000000000011100000000000000000
	dc.l 0b00000000000000000001111010000000
	dc.l 0b00000000000111000000000000000000
	dc.l 0b00000000000000000001111110000000
	dc.l 0b00000000000110000000000000000000
	dc.l 0b00000000000000000011111111000000
	dc.l 0b00000000000100000000000000000000
	dc.l 0b00000000000000000101111111100000
	dc.l 0b00000111001100000000000000000000
	dc.l 0b00000000000000001011111111110000
	dc.l 0b00001111111000100100000000000000
	dc.l 0b00000000000000010011011111110000
	dc.l 0b00001111110000100001000000000000
	dc.l 0b00000000000001000111011111111111
	dc.l 0b10111111100000000000000000000000
	dc.l 0b00000000000000000111011111111111
	dc.l 0b11111110000000100000000010000000
	dc.l 0b00000000000010001111001111111111
	dc.l 0b11111100000000100000000000000000
	dc.l 0b00000001001100001111000101111111
	dc.l 0b11111100000000100000000000000100
	dc.l 0b00001000011100001111000000111111
	dc.l 0b11110000000000000000001000000000
	dc.l 0b01000000111100000111000000000011
	dc.l 0b11000000000000000000000111000000
	dc.l 0b00000011111000000011100000000000
	dc.l 0b00000000000000000000000111111000
	dc.l 0b00000111111000000011100000000000
	dc.l 0b00000000000000000000000011111100
	dc.l 0b00011111110000000011100000000000
	dc.l 0b00000000000001010000000011111111

end_fb:

doSomething2:
	linkw %fp,#0
	unlk %fp
	rts

PRAM_buffer2:
	.long	0
end2:
